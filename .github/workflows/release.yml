name: Release

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY_ORGS: ghcr.io/rossigee
  CROSSPLANE_VERSION: v2.0.2
  GO_REQUIRED_VERSION: 1.25.5

permissions:
  packages: write
  contents: read

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_REQUIRED_VERSION }}

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run code generation
        run: make generate

      - name: Check go.mod is up to date
        run: |
          go mod tidy
          git diff --exit-code

      - name: Run unit tests
        run: make test

      - name: Run linting
        run: make lint

      - name: Build provider binary
        run: |
          make build PLATFORMS="linux_amd64" VERSION=${{ steps.version.outputs.version }}

      - name: Build and push Docker image (amd64)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./cluster/images/provider-hostinger/Dockerfile
          build-args: |
            TARGETOS=linux
            TARGETARCH=amd64
          tags: |
            ${{ env.REGISTRY_ORGS }}/provider-hostinger:${{ steps.version.outputs.version }}
            ${{ env.REGISTRY_ORGS }}/provider-hostinger:latest
          push: true

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## Provider Image
            Published to: `${{ env.REGISTRY_ORGS }}/provider-hostinger:${{ steps.version.outputs.version }}`

            ## Crossplane Installation
            ```bash
            kubectl apply -f - <<EOF
            apiVersion: pkg.crossplane.io/v1
            kind: Provider
            metadata:
              name: provider-hostinger
            spec:
              package: ${{ env.REGISTRY_ORGS }}/provider-hostinger:${{ steps.version.outputs.version }}
            EOF
            ```

            ## Documentation
            See the [README](https://github.com/rossigee/provider-hostinger) for installation and usage instructions.
          draft: false
          prerelease: false

      - name: Verify published artifacts
        run: |
          echo "Verifying published artifacts..."
          docker pull ${{ env.REGISTRY_ORGS }}/provider-hostinger:${{ steps.version.outputs.version }} && echo "✓ Docker image published" || echo "✗ Docker image not found"
          echo "Release complete: ${{ steps.version.outputs.version }}"
